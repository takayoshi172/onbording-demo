
<!doctype html>
<html lang="ja" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Onboarding Demo (GitHub Pages)</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #1f2328;
      --muted: #6e7781;
      --primary: #0969da;
      --accent: #2da44e;
      --danger: #cf222e;
      --overlay: rgba(0,0,0,0.6);
      --card: #f6f8fa;
      --focus: #ffdf5d;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0d1117;
        --fg: #c9d1d9;
        --muted: #8b949e;
        --primary: #58a6ff;
        --accent: #2ea043;
        --danger: #f85149;
        --overlay: rgba(0,0,0,0.7);
        --card: #161b22;
        --focus: #f2cc60;
      }
    }
    [data-theme="dark"] :root {
      --bg: #0d1117;
      --fg: #c9d1d9;
      --muted: #8b949e;
      --primary: #58a6ff;
      --accent: #2ea043;
      --danger: #f85149;
      --overlay: rgba(0,0,0,0.7);
      --card: #161b22;
      --focus: #f2cc60;
    }

    body {
      margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      background: var(--bg); color: var(--fg);
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; border-bottom: 1px solid #21262d;
      position: sticky; top: 0; background: var(--bg); z-index: 5;
    }
    .btn {
      appearance: none; border: 1px solid #30363d; background: var(--card); color: var(--fg);
      padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;
    }
    .btn.primary { background: var(--primary); border-color: var(--primary); color: white; }
    .btn.accent { background: var(--accent); border-color: var(--accent); color: white; }
    .btn.danger { background: var(--danger); border-color: var(--danger); color: white; }
    .btn:focus-visible { outline: 3px solid var(--focus); outline-offset: 2px; }

    main { max-width: 960px; margin: 24px auto; padding: 0 16px; }
    .card {
      background: var(--card); border: 1px solid #30363d; border-radius: 8px; padding: 16px; margin-bottom: 16px;
    }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .muted { color: var(--muted); font-size: 13px; }

    /* Overlay for tour highlighting */
    .overlay {
      position: fixed; inset: 0; background: var(--overlay); display: none; z-index: 10;
    }
    .overlay.show { display: block; }
    .highlight-ring {
      position: fixed; border: 2px solid var(--primary); border-radius: 8px; z-index: 11; pointer-events: none;
      box-shadow: 0 0 0 4px rgba(9,105,218,0.3);
    }
    .tooltip {
      position: fixed; z-index: 12; background: var(--card); color: var(--fg); border: 1px solid #30363d; border-radius: 8px;
      padding: 12px; max-width: 320px; box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    .tooltip h4 { margin: 0 0 6px 0; font-size: 16px; }
    .tooltip p { margin: 0 0 8px 0; font-size: 14px; }
    .tooltip .actions { display: flex; gap: 8px; justify-content: flex-end; }

    /* Onboarding modal */
    .modal-backdrop {
      position: fixed; inset: 0; background: var(--overlay); display: none; z-index: 20;
    }
    .modal-backdrop.show { display: block; }
    .modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: var(--card); color: var(--fg); border: 1px solid #30363d; border-radius: 12px; width: min(640px, 92vw);
      display: none; z-index: 21;
    }
    .modal.show { display: block; }
    .modal header { border-bottom: 1px solid #30363d; }
    .modal .content { padding: 16px; }
    .progress {
      height: 6px; background: #30363d; border-radius: 999px; overflow: hidden; margin: 8px 16px;
    }
    .progress > div { height: 100%; width: 0%; background: var(--primary); transition: width .25s ease; }
    .steps { display: grid; gap: 12px; }
    .checklist { display: grid; gap: 8px; margin-top: 8px; }
    .checklist label { display: flex; gap: 8px; align-items: center; }
    .footer { display: flex; justify-content: space-between; padding: 12px 16px; border-top: 1px solid #30363d; }

    /* Lang/Dark toggles */
    .segmented { display: inline-flex; border: 1px solid #30363d; border-radius: 8px; overflow: hidden; }
    .segmented button { border: none; padding: 8px 10px; background: transparent; color: var(--fg); cursor: pointer; }
    .segmented button.active { background: var(--primary); color: white; }

    /* Visually hidden */
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  </style>
</head>
<body>
  <header>
    <div class="toolbar">
      <button class="btn" id="startOnboardingBtn" aria-describedby="startHint">オンボーディングを開始</button>
      <span id="startHint" class="sr-only">初回ガイドを開始します</span>

      <div class="segmented" role="group" aria-label="言語切替">
        <button id="langJa" class="active" data-lang="ja">日本語</button>
        <button id="langEn" data-lang="en">English</button>
      </div>

      <div class="segmented" role="group" aria-label="テーマ切替">
        <button id="themeAuto" class="active" data-theme="auto">Auto</button>
        <button id="themeLight" data-theme="light">Light</button>
        <button id="themeDark" data-theme="dark">Dark</button>
      </div>

      <button class="btn" id="resetStateBtn">状態リセット</button>
      <span class="muted">ヒント: `?onboarding=1`で強制起動、`?reset=1`でリセット</span>
    </div>
  </header>

  <main>
    <section class="card">
      <h2 id="title-app">サンプルアプリ領域</h2>
      <p class="muted" id="desc-app">オンボーディングの「ツアー」対象になるUI要素をいくつか配置しています。</p>
      <div class="toolbar">
        <button class="btn accent" id="btnPrimaryAction">主要アクション</button>
        <button class="btn" id="btnSecondaryAction">補助アクション</button>
        <input id="searchInput" class="btn" style="width:240px" placeholder="検索キーワード…" aria-label="検索" />
        <button class="btn danger" id="btnDelete">削除</button>
      </div>
    </section>

    <section class="card">
      <h3 id="title-docs">ドキュメントリンク</h3>
      <p class="muted" id="desc-docs">GitHub Pages上の説明ページへ飛ぶリンクの例です。</p>
      <div class="toolbar">
        ./このページを再読込</a>
        #helpヘルプ(擬似)</a>
      </div>
    </section>
  </main>

  <!-- Overlay for tour -->
  <div class="overlay" id="tourOverlay" aria-hidden="true"></div>
  <div class="highlight-ring" id="tourRing" aria-hidden="true"></div>
  <div class="tooltip" id="tourTooltip" role="dialog" aria-modal="false" aria-live="polite" aria-hidden="true">
    <h4 id="tourTitle">ツアー</h4>
    <p id="tourBody">この要素の説明が入ります。</p>
    <div class="actions">
      <button class="btn" id="tourPrev">戻る</button>
      <button class="btn primary" id="tourNext">次へ</button>
      <button class="btn" id="tourSkip">スキップ</button>
    </div>
  </div>

  <!-- Onboarding modal -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true"></div>
  <section class="modal" id="onboardingModal" role="dialog" aria-labelledby="onboardingTitle" aria-modal="true" aria-describedby="onboardingDesc">
    <header>
      <h3 id="onboardingTitle" style="padding: 12px 16px; margin: 0;">オンボーディング</h3>
      <div class="progress" aria-label="進捗">
        <div id="progressBar" style="width:0%"></div>
      </div>
    </header>
    <div class="content">
      <div class="steps" id="stepsContainer" tabindex="0">
        <!-- 動的に差し替え -->
      </div>
      <div class="checklist" id="checklist">
        <label><input type="checkbox" data-key="readDocs" /> <span id="label-readDocs">ドキュメントを読んだ</span></label>
        <label><input type="checkbox" data-key="didPrimary" /> <span id="label-didPrimary">主要アクションを試した</span></label>
        <label><input type="checkbox" data-key="searchUsed" /> <span id="label-searchUsed">検索を使ってみた</span></label>
      </div>
    </div>
    <div class="footer">
      <div>
        <button class="btn" id="btnPrev">戻る</button>
        <button class="btn primary" id="btnNext">次へ</button>
      </div>
      <div>
        <button class="btn" id="btnSkip">スキップ</button>
        <button class="btn accent" id="btnFinish">完了</button>
      </div>
    </div>
  </section>

  <script>
    // --- i18n strings ---
    const STRINGS = {
      ja: {
        start: "オンボーディングを開始",
        appTitle: "サンプルアプリ領域",
        appDesc: "オンボーディングの「ツアー」対象になるUI要素をいくつか配置しています。",
        docsTitle: "ドキュメントリンク",
        docsDesc: "GitHub Pages上の説明ページへ飛ぶリンクの例です。",
        checklist: {
          readDocs: "ドキュメントを読んだ",
          didPrimary: "主要アクションを試した",
          searchUsed: "検索を使ってみた",
        },
        modalTitle: "オンボーディング",
        steps: [
          { title: "ようこそ！", body: "このガイドでは、画面上の主要な操作を順番にご紹介します。", type: "modal" },
          { title: "主要アクション", body: "「主要アクション」ボタンは頻繁に使います。位置と挙動を確認しましょう。", type: "tour", target: "#btnPrimaryAction", placement: "bottom" },
          { title: "検索ボックス", body: "検索から欲しい情報を素早く見つけられます。テキストを入力してみましょう。", type: "tour", target: "#searchInput", placement: "right" },
          { title: "注意が必要な操作", body: "削除ボタンは取り消しが難しい場合があります。誤操作を避けましょう。", type: "tour", target: "#btnDelete", placement: "top" },
          { title: "チェックリスト", body: "下のチェックリストで進捗を自己管理できます。完了した項目をチェックしましょう。", type: "modal" },
          { title: "完了！", body: "これで基本的な使い方の紹介は完了です。必要なときは上部のボタンからいつでも再実行できます。", type: "modal" }
        ],
        actions: { prev: "戻る", next: "次へ", skip: "スキップ", finish: "完了" },
        tour: { title: "ツアー" }
      },
      en: {
        start: "Start Onboarding",
        appTitle: "Sample App Area",
        appDesc: "UI elements below are used by the tour to demonstrate key actions.",
        docsTitle: "Documentation Links",
        docsDesc: "Example links to documentation hosted on GitHub Pages.",
        checklist: {
          readDocs: "Read documentation",
          didPrimary: "Tried primary action",
          searchUsed: "Used search",
        },
        modalTitle: "Onboarding",
        steps: [
          { title: "Welcome!", body: "This guide walks you through the key actions on screen.", type: "modal" },
          { title: "Primary Action", body: "The 'Primary Action' button is frequently used. Check its position and behavior.", type: "tour", target: "#btnPrimaryAction", placement: "bottom" },
          { title: "Search Box", body: "Use search to quickly find what you need. Try typing some text.", type: "tour", target: "#searchInput", placement: "right" },
          { title: "Destructive Action", body: "The delete button can be risky. Please avoid mis-clicks.", type: "tour", target: "#btnDelete", placement: "top" },
          { title: "Checklist", body: "Use the checklist below to track your progress.", type: "modal" },
          { title: "Done!", body: "You can re-run onboarding anytime from the top button.", type: "modal" }
        ],
        actions: { prev: "Back", next: "Next", skip: "Skip", finish: "Finish" },
        tour: { title: "Tour" }
      }
    };

    // --- state & helpers ---
    const LS_KEY = "onboarding.state.v1";
    const LS_CHECK = "onboarding.check.v1";
    const LS_LANG = "onboarding.lang.v1";
    const LS_THEME = "onboarding.theme.v1";

    const qs = (sel) => document.querySelector(sel);
    const qsa = (sel) => Array.from(document.querySelectorAll(sel));

    let lang = localStorage.getItem(LS_LANG) || "ja";
    let theme = localStorage.getItem(LS_THEME) || "auto";
    document.documentElement.setAttribute("lang", lang);
    document.documentElement.setAttribute("data-theme", theme);

    const setLangUI = () => {
      const S = STRINGS[lang];
      qs("#startOnboardingBtn").textContent = S.start;
      qs("#title-app").textContent = S.appTitle;
      qs("#desc-app").textContent = S.appDesc;
      qs("#title-docs").textContent = S.docsTitle;
      qs("#desc-docs").textContent = S.docsDesc;
      qs("#onboardingTitle").textContent = S.modalTitle;
      qs("#label-readDocs").textContent = S.checklist.readDocs;
      qs("#label-didPrimary").textContent = S.checklist.didPrimary;
      qs("#label-searchUsed").textContent = S.checklist.searchUsed;

      // segmented active states
      qsa('[data-lang]').forEach(btn => btn.classList.toggle('active', btn.dataset.lang === lang));
      qsa('[data-theme]').forEach(btn => btn.classList.toggle('active', btn.dataset.theme === theme));
    };

    const saveState = (s) => localStorage.setItem(LS_KEY, JSON.stringify(s));
    const loadState = () => {
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); } catch { return {}; }
    };
    const saveChecklist = () => {
      const obj = {};
      qsa('#checklist input[type="checkbox"]').forEach(cb => { obj[cb.dataset.key] = cb.checked; });
      localStorage.setItem(LS_CHECK, JSON.stringify(obj));
    };
    const loadChecklist = () => {
      try {
        const obj = JSON.parse(localStorage.getItem(LS_CHECK) || "{}");
        qsa('#checklist input[type="checkbox"]').forEach(cb => { cb.checked = !!obj[cb.dataset.key]; });
      } catch {}
    };

    // --- onboarding flow ---
    let currentStep = 0;
    let steps = STRINGS[lang].steps;

    function openModal() {
      qs("#modalBackdrop").classList.add("show");
      qs("#onboardingModal").classList.add("show");
      qs("#stepsContainer").focus();
      renderStep();
    }
    function closeModal() {
      qs("#modalBackdrop").classList.remove("show");
      qs("#onboardingModal").classList.remove("show");
      endTour();
    }
    function renderStep() {
      steps = STRINGS[lang].steps; // refresh for language
      const S = STRINGS[lang];
      const total = steps.length;
      currentStep = Math.max(0, Math.min(currentStep, total - 1));
      const st = steps[currentStep];
      qs("#progressBar").style.width = `${((currentStep+1)/total)*100}%`;

      const container = qs("#stepsContainer");
      container.innerHTML = `
        <h4>${st.title}</h4>
        <p>${st.body}</p>
      `;

      // control buttons label
      qs("#btnPrev").textContent = S.actions.prev;
      qs("#btnNext").textContent = S.actions.next;
      qs("#btnSkip").textContent = S.actions.skip;
      qs("#btnFinish").textContent = S.actions.finish;

      // tour or modal
      if (st.type === "tour") {
        startTour(st);
      } else {
        endTour();
      }

      saveState({ currentStep, completed: currentStep >= total-1 });
    }

    function startTour(st) {
      const target = qs(st.target);
      if (!target) { endTour(); return; }

      const overlay = qs("#tourOverlay");
      const ring = qs("#tourRing");
      const tip = qs("#tourTooltip");
      const S = STRINGS[lang];

      overlay.classList.add("show");
      tip.setAttribute("aria-hidden", "false");

      const rect = target.getBoundingClientRect();
      ring.style.left = `${rect.left - 6}px`;
      ring.style.top = `${rect.top - 6}px`;
      ring.style.width = `${rect.width + 12}px`;
      ring.style.height = `${rect.height + 12}px`;

      tip.querySelector("#tourTitle").textContent = S.tour.title;
      tip.querySelector("#tourBody").textContent = steps[currentStep].body;

      // Place tooltip
      const pad = 8;
      let x = rect.left, y = rect.bottom + pad;
      if (st.placement === "top") { y = rect.top - tip.offsetHeight - pad; x = rect.left; }
      if (st.placement === "right") { x = rect.right + pad; y = rect.top; }
      if (st.placement === "bottom") { x = rect.left; y = rect.bottom + pad; }
      tip.style.left = `${Math.max(8, Math.min(window.innerWidth - tip.offsetWidth - 8, x))}px`;
      tip.style.top = `${Math.max(8, Math.min(window.innerHeight - tip.offsetHeight - 8, y))}px`;
    }
    function endTour() {
      qs("#tourOverlay").classList.remove("show");
      qs("#tourTooltip").setAttribute("aria-hidden", "true");
      // hide ring by moving off-screen
      const ring = qs("#tourRing");
      ring.style.left = "-9999px"; ring.style.top = "-9999px"; ring.style.width = "0"; ring.style.height = "0";
    }

    // --- event bindings ---
    qs("#startOnboardingBtn").addEventListener("click", () => { currentStep = 0; openModal(); });

    qs("#btnPrev").addEventListener("click", () => { currentStep = Math.max(0, currentStep-1); renderStep(); });
    qs("#btnNext").addEventListener("click", () => { currentStep = Math.min(steps.length-1, currentStep+1); renderStep(); });
    qs("#btnSkip").addEventListener("click", () => { closeModal(); });
    qs("#btnFinish").addEventListener("click", () => { currentStep = steps.length-1; renderStep(); closeModal(); });

    qs("#tourPrev").addEventListener("click", () => { currentStep = Math.max(0, currentStep-1); renderStep(); });
    qs("#tourNext").addEventListener("click", () => { currentStep = Math.min(steps.length-1, currentStep+1); renderStep(); });
    qs("#tourSkip").addEventListener("click", () => { endTour(); });

    qsa('#checklist input[type="checkbox"]').forEach(cb => cb.addEventListener("change", saveChecklist));

    // language toggle
    qsa('[data-lang]').forEach(btn => btn.addEventListener('click', () => {
      lang = btn.dataset.lang; localStorage.setItem(LS_LANG, lang); setLangUI(); renderStep();
    }));
    // theme toggle
    qsa('[data-theme]').forEach(btn => btn.addEventListener('click', () => {
      theme = btn.dataset.theme; localStorage.setItem(LS_THEME, theme);
      document.documentElement.setAttribute("data-theme", theme);
      setLangUI(); // refresh active classes
    }));

    // keyboard shortcuts inside modal
    document.addEventListener("keydown", (e) => {
      const isOpen = qs("#onboardingModal").classList.contains("show");
      if (!isOpen) return;
      if (e.key === "Escape") { closeModal(); }
      if (e.key === "ArrowRight") { currentStep = Math.min(steps.length-1, currentStep+1); renderStep(); }
      if (e.key === "ArrowLeft") { currentStep = Math.max(0, currentStep-1); renderStep(); }
    });

    // simulate actions to help checklist
    qs("#btnPrimaryAction").addEventListener("click", () => {
      const obj = JSON.parse(localStorage.getItem(LS_CHECK) || "{}");
      obj["didPrimary"] = true; localStorage.setItem(LS_CHECK, JSON.stringify(obj)); loadChecklist();
      alert(lang === "ja" ? "主要アクションを実行しました" : "Primary action executed");
    });
    qs("#searchInput").addEventListener("input", () => {
      const obj = JSON.parse(localStorage.getItem(LS_CHECK) || "{}");
      obj["searchUsed"] = true; localStorage.setItem(LS_CHECK, JSON.stringify(obj));
      loadChecklist();
    });
    qs("#linkDocs").addEventListener("click", () => {
      const obj = JSON.parse(localStorage.getItem(LS_CHECK) || "{}");
      obj["readDocs"] = true; localStorage.setItem(LS_CHECK, JSON.stringify(obj));
      loadChecklist();
    });

    // init
    function initFromQuery() {
      const params = new URLSearchParams(location.search);
      if (params.get("reset") === "1") {
        localStorage.removeItem(LS_KEY);
        localStorage.removeItem(LS_CHECK);
        // keep language/theme
        alert(lang === "ja" ? "オンボーディング状態をリセットしました" : "Onboarding state reset");
      }
      if (params.get("onboarding") === "1") {
        currentStep = 0; openModal();
      }
    }

    function autoOpenIfFirstVisit() {
      const state = loadState();
      if (!state || !state.completed) {
        // 初回または未完了なら自動起動
        currentStep = state.currentStep || 0;
        openModal();
      }
    }

    // apply lang/theme
    setLangUI();
    loadChecklist();
    initFromQuery();
    // 自動起動（クエリ指定がなければ）
    if (!new URLSearchParams(location.search).get("onboarding")) {
      autoOpenIfFirstVisit();
    }
  </script>
</body>
</html>
